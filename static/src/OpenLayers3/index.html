<!--实现框选-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="ol.css" type="text/css">
    <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="ol.js" type="text/javascript"></script>
    <link href="../package/Viewer.js/css/viewer.min.css" rel="stylesheet">
    <script src="../package/Viewer.js/js/viewer.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <style>
        .wrap{
            width:100%;
            height: 700px;
            margin:0 auto;
            position: relative;
        }
        #left{
            width:20%;
            height: 100%;
            background: #ccffff;
            position: absolute;
            top:0;
            left:0;
        }
        #right{
            width:80%;
            height: 100%;
            background: #ffcccc;
            position: absolute;
            top:0;
            right:0;
        }
        #butong_net_left{
            heigh:300px;
            top:0;
            width: 100%;
            background: #0078A8;
            position: relative;
            overflow: hidden;
        }
        #select_type{
            height: 50%;
        }
        #edit_area{
            height: 50%;
        }
        li{
            list-style: none;
            margin-top: 10px;
        }
        li input{
            width: 100px;
        }
        #button_type_ul{
            /*text-align: center;*/
        }
        #btn_type_build{
            /*margin-top: 80%;*/
            width: 100px;
        }
        #map{
            border:5px solid red;
            height: 98%;
            width: 98%;
            margin: 0 auto;
            background: #aaaaaa;
        }
        #img_gallery_td{
            height:100px;
            width:270px;
            padding: 10px;
        }
    </style>
</head>
<body>
<div class="wrap">
    <aside id="left">
        <div id="select_type">
            <ul id="button_type_ul">
                <li><p>类别选项</p></li>
                <li><input type="button" value="显示地图" onclick="show_all_map()"></li>
                <li><p>弹窗选项</p></li>
                <li><label><input  type="radio" name="show_popup" >显示弹窗</label></li>
                <li><label><input  type="radio" name="show_popup" checked="checked">不显示弹窗</label></li>
                <li><input type="button" value="烽火台"></li>
                <li><input type="button" value="墙体"></li>
                <li><input type="button" value="暗门"></li>
            </ul>
        </div>
        <div id="edit_area">
            <ul>
                <li><p>编辑区域</p></li>
                <li>建筑类型：
                    <!--                    <input type="text" id="type_build">-->
                    <select id="type_build">
                        <option value="烽火台">烽火台</option>
                        <option value="墙体">墙体</option>
                        <option value="暗门">暗门</option>
                    </select>
                </li>
                <li>保存状况：<input type="text" id="save_condition"></li>
                <li> <input id="btn_type_build" type="button" value="确定" onclick="btn_modifyWFS()"></li>
            </ul>
        </div>
    </aside>
    <section id="right">
        <div id="map"></div>
    </section>
</div>
<div id="butong_net_left">
    <table cellpadding="0" cellspacing="0" border="0">
        <tr><td id="butong_net_left1" valign="top" align="center">
            <table cellpadding="2" cellspacing="0" border="0">
                <tr id="img_gallery" align="center">
                    <!--                    <td><img src="../package/img/DJI_0067.jpg" height="100" width="270"></td>-->
                    <!--                    <td><img src="../package/img/DJI_0067.jpg" height="100" width="270"></td>-->
                    <!--                    <td><img src="../package/img/DJI_0067.jpg" height="100" width="270"></td>-->
                    <!--                    <td><img src="../package/img/DJI_0067.jpg" height="100" width="270"></td>-->
                    <!--                    <td><img src="../package/img/DJI_0067.jpg" height="100" width="270"></td>-->
                </tr>
            </table>
        </td>
            <td id="butong_net_left2" valign="top"></td>
        </tr>
    </table>
</div>
<div id="popup" title="详细信息"></div>
<script type="text/javascript">
    var format="image/png";
    var bounds=[73.441277, 18.159829,
        135.08693, 53.561771];
    var untiled=new ol.layer.Image({
        source:new ol.source.ImageWMS({
            ratio:1,
            url: 'http://localhost:8080/geoserver/GreateWall/wms',
            params: {'FORMAT': format,
                'VERSION': '1.1.1',
                "LAYERS": 'GreateWall:%E7%9C%81%E7%95%8C_region',
                "exceptions": 'application/vnd.ogc.se_inimage',
            }
        })
    });
    var tiled = new ol.layer.Tile({
        visible: false,
        source: new ol.source.TileWMS({
            url: 'http://localhost:8080/geoserver/GreateWall/wms',
            params: {'FORMAT': format,
                'VERSION': '1.1.1',
                tiled: true,
                "LAYERS": 'GreateWall:%E7%9C%81%E7%95%8C_region',
                "exceptions": 'application/vnd.ogc.se_inimage',
                tilesOrigin: 73.441277 + "," + 18.159829
            }
        })
    });
    function wfs(name) {
        var wfsParams = {
            service : 'WFS',
            version : '1.0.0',
            request : 'GetFeature',
            typeName : name,  //图层名称
            outputFormat : 'text/javascript',  //重点，不要改变
            format_options : 'callback:loadFeatures'  //回调函数声明
        };
        var vectorSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            loader: function(extent, resolution, projection) {  //加载函数
                var url = 'http://localhost:8080/geoserver/wfs';
                $.ajax({
                    url: url,
                    data : $.param(wfsParams),   //传参
                    type : 'GET',
                    dataType: 'jsonp',   //解决跨域的关键
                    jsonpCallback:'loadFeatures'  //回调
                });
            },
            strategy: ol.loadingstrategy.tile(new ol.tilegrid.createXYZ({
                maxZoom: 25
            })),
            projection: 'EPSG:4326'
        });
        //回调函数使用
        window.loadFeatures = function(response) {
            vectorSource.addFeatures((new ol.format.GeoJSON({
                geometryName: 'geom'//改成geom，要素则不显示在界面上
            })).readFeatures(response));  //载入要素
        };
        var vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 15,
                    fill: new ol.style.Fill({
                        color: 'red'
                    })
                })
            })
        });
        return vectorLayer;
    }
    var wfs_layer = null;
    function clcall(){
        if(wfs_layer){
            map.removeLayer(wfs_layer);
            wfs_layer = null;
        }
    }
    function show_all_map() {
        var name='GreateWall:selected';
        clcall();
        wfs_layer=wfs(name);
        map.addLayer(untiled);//显示底图
        map.addLayer(tiled);
        map.addLayer(wfs_layer);
    }
    var map = new ol.Map({
        target: document.getElementById('map'),
        view: new ol.View({
            center: [98.23584, 39.84159],// ol.proj.transform([98.23584, 39.84159], 'EPSG:4326','EPSG:3857'),
            projection: 'EPSG:4326',
            maxZoom: 19,
            zoom: 4
        })
    });
    //实现高亮显示
    var featureOverlay = new ol.layer.Vector({
        source: new ol.source.Vector(),
        map: map,
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 5,
                fill: null,
                stroke: new ol.style.Stroke({color: 'red', width: 20})
            })
        })
    });
    var highlight;
    var img_path_html='';
    var displayFeatureInfo=function (pixel,coordinate) {
        var feature=map.forEachFeatureAtPixel(pixel,function (feature) {
            return feature;
        });
        if(feature){
            var img_path=feature.getProperties()['img_path'];
            var save_condition_pop=feature.getProperties()['save_condition'];
            console.log(save_condition_pop);
            // var img_name_split=img_path.toString().split("/");
            // var img_name_1='../'+img_name_split[1];
            // for (i=2;i<img_name_split.length-1;i++)
            // {
            //     img_name_1=img_name_1+'/'+img_name_split[i];
            // }
            // img_name_1=img_name_1+'/'+img_name_split[img_name_split.length-1].toString().split(".")[0]+'.jpg';//一定要小写
            // img_name_1=img_name_1.replace(/\s+/g,"%20");
            // img_path_html=img_path_html+'<td><img id="img_gallery_td" src='+img_name_1+' onclick="viewPic()"></td>';

            var popup_flag=document.getElementsByName("show_popup")[0].checked;
            if(popup_flag){
                var element = popup.getElement();   // 获取充当弹窗的DOM元素
                $(element).popover('destroy');
                popup.setPosition(coordinate);  // 将弹窗位置设置为鼠标点击处
                $(element).popover({
                    placement: 'top',
                    animation: false,
                    html: true,
                    content: '<p style="height: 50px;width: 100px">建筑保存状态:</p><code>' + feature.getProperties()['save_condition'] + '</code>'+
                        '<p style="height: 50px;width: 100px">建筑类型:</p><code>' + feature.getProperties()['type_build'] + '</code>'
                });
                $(element).popover('show');
                console.log(img_name_1);//高度
            }
            else{
                var element = popup.getElement();   // 获取充当弹窗的DOM元素
                $(element).popover('destroy');
            }
        }
        if (feature !== highlight) {
            if (highlight) {
                featureOverlay.getSource().removeFeature(highlight);
            }
            if (feature) {
                featureOverlay.getSource().addFeature(feature);
            }
            highlight = feature;
        }
    }
    function viewPic() {//放大图片展示
        var galley=document.getElementById('img_gallery');
        var viewer=new Viewer(galley,{
            url:'data-original',
            hidden:function () {
                viewer.destroy();
            }
        });
        viewer.show();
    }
    $(document).keyup(function (e) {
        if(e.keyCode==13){
            console.log("map被双击"+img_path_html);
            document.getElementById('img_gallery').innerHTML=img_path_html;
            img_path_html='';

            //下部图像gallery效果
            var speed=30//速度数值越大速度越慢
            butong_net_left2.innerHTML=butong_net_left1.innerHTML
            function Marquee3(){
                if(butong_net_left2.offsetWidth-butong_net_left.scrollLeft<=0)
                    butong_net_left.scrollLeft-=butong_net_left1.offsetWidth
                else{
                    butong_net_left.scrollLeft++
                }
            }
            var MyMar3=setInterval(Marquee3,speed)
            butong_net_left.onmouseover=function() {clearInterval(MyMar3)}
            butong_net_left.onmouseout=function() {MyMar3=setInterval(Marquee3,speed)}
            //gallery效果结束
        }
    });
    function modifyWFS(pixel) {
        var feature_m=map.forEachFeatureAtPixel(pixel,function (feature) {
            return feature;
        });
        if(feature_m){
            var save_type=document.getElementById('save_condition').value;
            console.log(save_type);
            feature_m.setProperties({'save_condition':save_type});
            var type_build=document.getElementById('type_build').value;
            console.log(type_build);
            feature_m.setProperties({'type_build':type_build});
            var WFSTSerializer = new ol.format.WFS();
            feature_m.getGeometry().applyTransform(function (flatCoordinates,flatCoordinates2,stride) {
                for (var j=0;j<flatCoordinates.length;j+=stride){
                    var y = flatCoordinates[j];
                    var x = flatCoordinates[j + 1];
                    flatCoordinates[j] = x;
                    flatCoordinates[j + 1] = y;
                }
            });
            var featObject = WFSTSerializer.writeTransaction(null,
                [feature_m], null, {//插入，修改，删除
                    featureType: 'selected',//图层名称，需要根据实际情况进行更改
                    featureNS: 'http://localhost:8080/GreateWall',  // 注意这个值必须为创建工作区时的命名空间URI
                    srsName: 'EPSG:4326'
                });
            var serializer = new XMLSerializer();
            var featString = serializer.serializeToString(featObject);
            var request = new XMLHttpRequest();
            request.open('POST', 'http://localhost:8080/geoserver/wfs?service=wfs');
            // 指定内容为xml类型
            request.setRequestHeader('Content-Type', 'text/xml');
            request.send(featString);
        }
    }

    // 用户点击地图就会弹出来的弹窗
    var popup = new ol.Overlay({
        element: document.getElementById('popup')
    });
    map.addOverlay(popup);

    var pixel='';
    function btn_modifyWFS(){
        modifyWFS(pixel);
        pixel='';
    }

    map.on('click',function (evt) {
        selectedFeatures.clear();
        displayFeatureInfo(evt.pixel,evt.coordinate);
        // modifyWFS(evt.pixel);
        pixel=evt.pixel;
        show_all_map();
    })

    //实现框选效果
    var boxSelect = new ol.interaction.Select();
    var selectedFeatures = boxSelect.getFeatures();
    var dragBox = new ol.interaction.DragBox({
        //condition : ol.events.condition.always  默认是always
    });
    map.addInteraction(dragBox);
    dragBox.on('boxend', function() {
        var extent = dragBox.getGeometry().getExtent();
        console.log(extent);//box的坐标

        var feature_test=wfs_layer.getSource().getFeaturesInExtent(extent);
        console.log(feature_test);
        for(var j=0;j<feature_test.length;j++){
            var img_path=feature_test[j].getProperties()['img_path'];

            var img_name_split=img_path.toString().split("/");
            var img_name_1='../'+img_name_split[1];
            for (i=2;i<img_name_split.length-1;i++)
            {
                img_name_1=img_name_1+'/'+img_name_split[i];
            }
            img_name_1=img_name_1+'/'+img_name_split[img_name_split.length-1].toString().split(".")[0]+'.jpg';//一定要小写
            img_name_1=img_name_1.replace(/\s+/g,"%20");
            img_path_html=img_path_html+'<td><img id="img_gallery_td" src='+img_name_1+' onclick="viewPic()"></td>';
            console.log(img_path_html);
        }
    });
    dragBox.on('boxstart', function() {
        selectedFeatures.clear();
    });
    map.on('click', function() {
        selectedFeatures.clear();
    });
    map.addInteraction(boxSelect);
    //结束


</script>
</body>
</html>